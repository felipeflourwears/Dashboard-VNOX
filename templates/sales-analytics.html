<div class="sales-analytics">
    <h2>Reports</h2>
    <!-- <div class="item online">
        <div class="icon">
            <span class="material-icons-sharp">settings_applications</span>
        </div>
        <div class="right">
            <div class="info">
                <h3>PLAYERS</h3>
                <small class="text-muted">Last 24 Hours</small>
            </div>
            <h5 class="success">+39%</h5>
            <h3>3849</h3>
        </div>
    </div> -->

    <!-- <div class="item offline">
        <div class="icon">
            <span class="material-icons-sharp">schedule</span>
        </div>
        <div class="right">
            <div class="info">
                <h3>TIME CHANGE</h3>
                <small class="text-muted">Last 24 Hours</small>
            </div>
            <h5 class="danger">-17%</h5>
            <h3>1100</h3>
        </div>
    </div> -->

    <!-- <div class="item customers">
        <div class="icon">
            <span class="material-icons-sharp">filter_list_off</span>
        </div>
        <div class="right">
            <div class="info">
                <h3>OFFLINE</h3>
                <small class="text-muted">Last 24 Hours</small>
            </div>
            <h5 class="success">+25%</h5>
            <h3>3333</h3>
        </div>
    </div> -->
    
   <!--  <a href="/send_report" class="item add-product" onclick="openPopupMail(event)">
        <div>
            <div>
                <span class="material-icons-sharp">mail</span>
                <h3>Send Report Players</h3>
            </div>
        </div>
    </a>    -->
    {% if page == "vnnox" %}     
    <form action="/download_report_vnnox" method="POST" class="item download" id="downloadForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <!-- Agregar cada playerId como un campo oculto -->
        {% for player_id in player_ids %}
        <input type="hidden" name="player_ids[]" value="{{ player_id }}">
        {% endfor %}
    
        <!-- Campo oculto para controlar la respuesta de descarga -->
        <input type="hidden" id="downloadCompleted" name="downloadCompleted" value="false">
        
        <button type="submit" style="all: unset; cursor: pointer;">
            <div>
                <div>
                    <span class="material-icons-sharp">mail</span>
                    <h3>Download Report Players</h3>
                </div>
            </div>
        </button>
    </form>
    {% elif page == "zkong" %}
    <form action="/download_report_zkong" method="POST" class="item download" id="downloadForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <input type="hidden" name="player_ids[]" value="{{ datos_pdf }}">
        

        <!-- Campo oculto para controlar la respuesta de descarga -->
        <input type="hidden" id="downloadCompleted" name="downloadCompleted" value="false">
        
        <button type="submit" style="all: unset; cursor: pointer;">
            <div>
                <div>
                    <span class="material-icons-sharp">mail</span>
                    <h3>Download Report Players</h3>
                </div>
            </div>
        </button>
    </form>
    {% elif page == "hexnode" %}
    <form action="/download_report_hexnode" method="POST" class="item download" id="downloadForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <input type="hidden" name="players_info[]" value="{{ players_info }}">
        

        <!-- Campo oculto para controlar la respuesta de descarga -->
        <input type="hidden" id="downloadCompleted" name="downloadCompleted" value="false">
        
        <button type="submit" style="all: unset; cursor: pointer;">
            <div>
                <div>
                    <span class="material-icons-sharp">mail</span>
                    <h3>Download Report Players</h3>
                </div>
            </div>
        </button>
    </form>
    {% endif %}
    
    <!-- <a href="/button_test" class="item download">
        <div>
            <div>
                <span class="material-icons-sharp">mail</span>
                <h3>Test</h3>
            </div>
        </div>
    </a> -->

  <!--   <a href="#" class="item add-product">
        <div>
            <div>
                <span class="material-icons-sharp">add</span>
                <h3>Add Product</h3>
            </div>
        </div>
    </a> -->

</div>

<script>
    document.getElementById('downloadForm').addEventListener('submit', function(event) {
        // Mostrar el loader al enviar el formulario
        document.getElementById('loaderContainer').style.display = 'flex';
        
        // Evitar el envío del formulario normalmente
        event.preventDefault();

        // Realizar la solicitud al servidor para descargar el archivo
        var form = this;
        var xhr = new XMLHttpRequest();
        xhr.open(form.method, form.action, true);
        xhr.responseType = 'blob'; // Especificar que esperamos una respuesta en formato blob (archivo)

        // Manejar la respuesta del servidor
        xhr.onload = function() {
            if (xhr.status === 200) {
                // Crear un objeto URL para el archivo descargado
                var blob = new Blob([xhr.response], { type: 'application/pdf' });
                var url = window.URL.createObjectURL(blob);

                // Crear un enlace invisible para descargar el archivo
                var a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'report.pdf'; // Nombre del archivo que se descargará
                document.body.appendChild(a);
                a.click();

                // Liberar el objeto URL creado
                window.URL.revokeObjectURL(url);

                // Ocultar el loader después de descargar el archivo
                document.getElementById('loaderContainer').style.display = 'none';
            } else {
                console.error('Hubo un problema al descargar el archivo.');
                // Aquí puedes manejar el error si es necesario
            }
        };

        // Enviar el formulario con los datos
        xhr.send(new FormData(form));
    });
</script>

